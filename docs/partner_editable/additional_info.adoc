:xrefstyle: short

// Add steps as necessary for accessing the software, post-configuration, and testing. Don’t include full usage instructions for your software, but add links to your product documentation for that information.
//Should any sections not be applicable, remove them

== Post-deployment steps

After you launch the stack, verify your deployment and, if desired, modify your implementation, as described in the following sections.

=== Verify your deployment

. Verify that the ECS cluster contains the number of instances that you want. 
.. Open the Amazon ECS console.
.. In the left pane, choose *Clusters*.
.. Choose the *ECS Instances* tab.  
. Verify the MFA configuration. 
.. Open the Directory Service console.
.. Select your directory.
.. Choose the *Networking & security* tab.
.. Find the *Multi-factor authentication* pane at the bottom of the page.
.. Verify that the RADIUS status is *Completed*. You may need to wait for the status to appear; Systems Manager can take a few minutes to register and configure the instances. If the status is *Failed*, see the link:#_troubleshooting[Troubleshooting] section of this guide.
.. Verify that the configuration otherwise looks as you expect. To change anything, choose *Actions*, *Edit*. (The RADIUS instances' IP addresses were created by the Auto Scaling group. The shared secret code values are empty for security reasons.)
. Verify that MFA is working in an Amazon WorkSpaces client.
.. Open the Amazon WorkSpaces client.
.. Use the registration code from your registered ADC that you used for the Duo setup earlier. 
.. Under the username and password boxes, in the third text box, enter the MFA code from the Duo Mobile app or the hardware security token mentioned earlier.
. If you chose directory synchronization earlier, synchronize users to Duo Cloud, and add hardware tokens.
.. Open the Duo administrator panel. Choose *Users* on the left side of screen, and choose *Directory Sync* near the top right. 
.. Enter the NTLM (Active Directory) domain and the NTLM workstation: the hostname of one of the Duo Radius ECS IP addresses (example: 10.0.10.10, 10.0.11.10).
.. At the bottom of the page, choose *Refresh*. This brings you to the top of the page, which instructs you to select a group to import.
.. At the bottom of the page, for *Groups*, enter the Active Directory user group you want to import into Duo. Choose *Save Groups*.
.. At the top of the page, select *Sync Now*.
.. On the left, choose *Users*. Review the user list that was imported from your Active Directory group. You should see details about the users that were imported from Active Directory as well as Duo-specific details.
.. Add hardware tokens. To do so, select a user, choose *Add Hardware Token*, enter the serial number of one of the tokens that you ordered, and then choose *Attach Hardware Token*.
. Update user settings for each user.
.. From the Duo administrator panel, choose *Users* on the left side of the screen, and select a user.
.. Choose the status—either *Active* or *Bypass*—to determine whether to require MFA when that user logs in.
.. (Optional) Add a phone number so that the user can use the Duo Mobile app.

=== Modify your implementation

If you want to increase or decrease the number of RADIUS tasks after implementing the solution, update the CloudFormation stack and specify the desired number of servers, then perform a stack update. If you increase the number of tasks, the ECS service starts up that number of new tasks and installs and configures the Duo Authentication Proxy service for each. 

:xrefstyle: short
[#duo_ecs_service_stable]
.ECS service stable
[link=images/duo_ecs_service_stable.png]
image::../images/duo_ecs_service_stable.png[Architecture,width=75%,height=75%]

After each task is configured, the ECS service triggers an event notifying that the service has reached a steady state, as shown in <<duo_ecs_service_stable>>.
 
That CloudWatch event triggers a Lambda function that finds the IP address of the Fargate task and updates the SSM parameter *DuoServiceIps*, which triggers another event that updates the Directory Service MFA. The whole process takes 2-3 minutes.
 
Application Autoscaling in the ECS service automatically scales the ECS tasks when CPU or memory limits are reached. This allows for handling spikes in traffic, such as early morning logins. Likewise, when the ECS service does not see much activity Application Autoscaling decreases the number of tasks, and then triggers the preceding workflow to get IP addresses from Lambda functions and update the Directory Service RADIUS configuration.

Stand up a regular trigger on a pipeline to get the latest code and build it. By default, the trigger frequency is set to weekly. This frequency can be changed with an AWS CloudFormation parameter when you create or update the stack. When the secrets are rotated, the newest image is automatically pulled and deployed. ECR is configured to scan on push; CodeBuild jobs can wait for the results of the scan before completing. If the build or scan fails, Duo administrators are notified.
