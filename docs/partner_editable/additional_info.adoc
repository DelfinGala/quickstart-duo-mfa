:xrefstyle: short

// Add steps as necessary for accessing the software, post-configuration, and testing. Don’t include full usage instructions for your software, but add links to your product documentation for that information.
//Should any sections not be applicable, remove them

== Post-deployment steps

After you launch the stack, follow these steps.
//TODO Marcia to massage this intro after talking with Dave.

=== Verifying the deployment

. Open the Amazon ECS console. Choose *Clusters* at the left, and choose the *ECS Instances* tab. Verify that the ECS cluster contains the number of instances that you want. 
. Look for *ECS Cluster*. Under *ECS service*, you should see two tasks with a status of *Pending* or *Running*. Choose one of the tasks, and view the logs in CloudWatch using either of these methods (as shown in <<ecs_task_cloudwatch_logs>>):
* Choose the top tab (*Logs*).
* In the *Containers* section, choose *View logs in CloudWatch*.
//TODO Dave, What should we look for in the logs; why do we do this step?
+
[#ecs_task_cloudwatch_logs]
[link=images/duo_ecs_service_task_logs.png]
.Access to an ECS task's CloudWatch logs
image::../images/duo_ecs_service_task_logs.png[75%]
+
. Verify the MFA configuration. To do this, open the Directory Service console, select your directory, choose the *Networking & security* tab, and find the *Multi-factor authentication* pane at the bottom of the page.
* Verify that the RADIUS status is *Completed*. If the status is *Failed*, see the link:#_troubleshooting[Troubleshooting] section of this guide. (You may need to wait for the status to appear; Systems Manager can take a few minutes to register and configure the instances.) 
* Verify that the configuration otherwise looks as you expect. To change anything, choose *Actions*, *Edit*. (The RADIUS instances' IP addresses were created by the Auto Scaling group. The shared secret code values are empty for security reasons.)
//TODO Dave, How are these next few steps nested? What are we accomplishing in this section?
. Open the Amazon WorkSpaces client.
. Use the registration code from your registered ADC that you used for the Duo setup earlier. 
. Under the username and password boxes, in the third text box, enter the MFA code from the Duo Mobile app or the hardware security token mentioned earlier.
. If you chose directory sync earlier, sync users to Duo Cloud and add the hardware token.
. After you have validated that everything is working, go back to the Duo administrator site.
//TODO Dave, what does this "everything" above refer to?
//TODO Dave, Is "site" above the same as what we've called "panel" elsewhere?
. Either go back to the screen you left open for Add New Directory or click on *Users* on the left hand side of screen, then click on *Directory Sync* near the top right.
//TODO Dave, Is this step above still only for people who chose directory sync earlier? And the following steps?
. Enter the NTLM domain (the Active Directory domain).
. Enter the NTLM workstation: the hostname of one of the Duo Radius ECS ip addresses (example: 10.0.10.10, 10.0.11.10).
. At the bottom of the page, choose *Refresh*. This brings you to the top of the page, which instructs you to select a group to import.
//TODO Dave, Does the word "Refresh" appear in the UI?
. At the bottom of the page, for *Groups*, enter the AD user group you want to import into Duo. 
. Choose *Save Groups*.
. At the top of the page, select *Sync Now*.
. On the left, choose *Users*. Review the user list that was imported from your AD group. Notice the following:
* When you choose a user, you see details that were imported about the user as well as additional Duo-specific details. 
* You can toggle the status between *Active* and *Bypass* to tell the system whether to require MFA when that user logs in.
* You can add a phone number to allow a user to use the Duo Mobile app.
* You can add a hardware token. To do so, choose *Add Hardware Token*, enter the serial number of one of the tokens that you ordered, and then choose *Attach Hardware Token*.

=== Modify your implementation

If you want to increase or decrease the number of RADIUS tasks after implementing the solution, update the CloudFormation stack and specify the desired number of servers. If you increase the number of tasks, the ECS service starts up that number of new tasks and installs and configures the Duo Authentication Proxy service for each new task. 

:xrefstyle: short
[#duo_ecs_service_stable]
.ECS service stable
[link=images/duo_ecs_service_stable.png]
image::../images/duo_ecs_service_stable.png[Architecture,width=75%,height=75%]

After each task is configured, the ECS service triggers an event notifying that the service has reached a steady state, as shown in <<duo_ecs_service_stable>>.
 
That CloudWatch event triggers a Lambda function that finds the IP address of the Fargate task and updates the SSM parameter *DuoServiceIps*, which triggers another event that updates the Directory Service MFA. The whole process takes 2-3 minutes.
 
Application Autoscaling in the ECS service automatically scales the ECS tasks when CPU or memory limits are reached. This allows for handling spikes in traffic, such as early morning logins. Likewise, when the ECS service does not see much activity Application Autoscaling decreases the number of tasks, and then triggers the preceding workflow to get IP addresses from Lambda functions and update the Directory Service RADIUS configuration.

It is recommended that you stand up a regular trigger on a pipeline to get the latest code and build it. By default, the trigger frequency is set to weekly, which can be changed with an AWS CloudFormation parameter during stack creation or update. When the secrets are rotated, the newest image is automatically pulled and deployed. ECR is configured to scan on push; builds can wait to see the results of the scan. If the build or scan fails, Duo administrators are notified.

//TODO Dave, In the preceding paragraph, what does "builds can wait to see the results of the scan" mean?
